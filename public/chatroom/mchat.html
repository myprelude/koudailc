<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta id="viewport" name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1,user-scalable=no">
    <meta name="é™ŒèŠ" content="websocket--åœ¨çº¿èŠå¤©">
    <title>è¿ªæ‹œæ¡åƒåœ¾</title>
    <link href="//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <!-- <link rel="stylesheet" href="../assets/css/jquery.mCustomScrollbar.min.css" /> -->
    <link href="../css/mchat.css" rel="stylesheet">
    <link rel="shortcut icon" type="image/png" href="assets/img/favicon.png" />
</head>
<style>
    .mCSB_inside>.mCSB_container{
        margin-right: 0px;
    }
</style>
<body>
    <!-- åŠ è½½æ¡ -->
    <style>
        #loading{
            position: fixed;
            top:0;
            left:0;
            width:100%;
            height:100%;
            z-index:10000;
            background: #ffffff;
            overflow: hidden;
        }
        .spinner {
            position: absolute;
            width: 60px;
            height: 60px;
            top:50%;
            left:50%;
            margin-left:-30px;
            background-color: #5F5A4B;
            -webkit-animation: rotateplane 1.2s infinite ease-in-out;
            animation: rotateplane 1.2s infinite ease-in-out;
        }
        
        @-webkit-keyframes rotateplane {
            0% { -webkit-transform: perspective(120px) }
            50% { -webkit-transform: perspective(120px) rotateY(180deg) }
            100% { -webkit-transform: perspective(120px) rotateY(180deg)  rotateX(180deg) }
        }
        
        @keyframes rotateplane {
            0% {
                transform: perspective(120px) rotateX(0deg) rotateY(0deg);
                -webkit-transform: perspective(120px) rotateX(0deg) rotateY(0deg)
            } 50% {
                transform: perspective(120px) rotateX(-180.1deg) rotateY(0deg);
                -webkit-transform: perspective(120px) rotateX(-180.1deg) rotateY(0deg)
            } 100% {
                transform: perspective(120px) rotateX(-180deg) rotateY(-179.9deg);
                -webkit-transform: perspective(120px) rotateX(-180deg) rotateY(-179.9deg);
            }
        }
    </style>
    <div id='loading'>
            <div class="spinner"></div>
    </div>
    <!-- å¼¹å±‚ -->
    <div class='modal-show'>
        <div class='login-box'>
            <div class='userInfo'>
                <h3>æ¬¢è¿åˆ°èŠå¤©å®¤</h3>
                <div>
                    <h5 style='margin-top:60px;margin-bottom:25px;'>è¯·é€‰æ‹©èŠå¤©å›¾åƒ</h5>
                    <div class='user-img'>
                        <div><img src="../user/1.jpg" alt=""><span class="glyphicon glyphicon-ok" aria-hidden="true"></span></div>
                        <div><img src="../user/2.jpg" alt=""><span  aria-hidden="true"></span></div>
                        <div><img src="../user/3.jpg" alt=""><span  aria-hidden="true"></span></div>
                        <div><img src="../user/4.jpg" alt=""><span  aria-hidden="true"></span></div>
                        <div><img src="../user/5.png" alt=""><span  aria-hidden="true"></span></div>
                        <div><img src="../user/6.jpg" alt=""><span  aria-hidden="true"></span></div>
                        <div><img src="../user/7.jpg" alt=""><span  aria-hidden="true"></span></div>
                        <div><img src="../user/8.jpg" alt=""><span  aria-hidden="true"></span></div>
                        <div><img src="../user/9.jpg" alt=""><span  aria-hidden="true"></span></div>
                        <div><img src="../user/10.jpg" alt=""><span  aria-hidden="true"></span></div>
                    </div>
                    <div class="input-group username">
                        <span class="glyphicon glyphicon-user" ></span>
                        <div class='input'>
                            <input type="text" class="form-control" placeholder="è¯·å¡«å†™ä½ çš„èŠå¤©å" id='usernameval' >
                        </div>
                    </div>
                    <div class='btn-go'>è¿›å…¥èŠå¤©å®¤</div>
                </div>
            </div>
            
        </div>
    </div>
    <!-- èŠå¤©ç•Œé¢ -->
    <div class='chat-interface'>
        <div class='contact-bar'>
            <div class='header header-bar'>
                <div class='bar-1'>èŠå¤©å¹ç‰›é€¼</div>
                <div class='bar-2'><span class="glyphicon glyphicon-search" aria-hidden="true"></span></div>
                <div class='bar-3'><span class="glyphicon glyphicon-cog" aria-hidden="true"></span></div>
            </div>
            <div class='content-bar '>
                <ul class='scrollbar' id='mCSB_1_container'>
                    <li class='active'>
                        <div class='line'></div>
                        <img src="../user/qq.jpg" alt="">
                        <b>Qz--ç¾¤èŠ</b>
                        <span id="ALLUser" ids='ALL'></span>
                        <!-- <i class='breath'>1</i> -->
                    </li>
                </ul>
            </div>
        </div>
        <div class='contact-info'>
            <div class='header header-info'>
                <div class='info-1'><img src="../user/user.jpg" alt="" id='title-img'></div>
                <div class='info-2'>
                    <div><b id='title-name'>myPrelude</b></div>
                    <small>æ¬¢è¿æ¥åˆ°é™ŒèŠï¼Œå¼€å¯éšç¼˜èŠå¤©ï¼</small>
                </div>
                <div class='info-3'><span class="glyphicon glyphicon-th-large" aria-hidden="true"></span></div>
            </div>
            <div class='content-info'>
                <div class='conetent-text-box scrollbar' id='id_ALL'>
                    <div class='textbox'></div>
                </div>
            </div>
            <div class='write-info'>
                <!-- loading -->
                
                <!-- loading end -->
                <div class='write-bar'>
                    <div class='send-option'>
                        <p class='icon-style'>
                            <span style="color: rgb(7, 255, 125);">ğŸ˜Š</span>
                            <span style="color: rgb(7, 255, 120);">ğŸ˜</span>
                            <span style="color: rgb(7, 255, 115);">ğŸ˜˜</span>
                            <span style="color: rgb(7, 255, 110);">ğŸ˜³</span>
                            <span style="color: rgb(7, 255, 105);">ğŸ˜¡</span>
                            <span style="color: rgb(7, 255, 100);">ğŸ˜“</span>
                            <span style="color: rgb(7, 255, 95);">ğŸ˜­</span>
                            <span style="color: rgb(7, 255, 90);">ğŸ˜²</span>
                            <span style="color: rgb(7, 255, 85);">ğŸ˜</span>
                            <span style="color: rgb(7, 255, 80);">ğŸ˜±</span>
                            <span style="color: rgb(7, 255, 75);">ğŸ˜–</span>
                            <span style="color: rgb(7, 255, 70);">ğŸ˜‰</span>
                            <span style="color: rgb(7, 255, 65);">ğŸ˜</span>
                            <span style="color: rgb(7, 255, 60);">ğŸ˜œ</span>
                            <span style="color: rgb(7, 255, 55);">ğŸ˜°</span>
                            <span style="color: rgb(7, 255, 50);">ğŸ˜¢</span>
                            <span style="color: rgb(7, 255, 45);">ğŸ˜š</span>
                            <span style="color: rgb(7, 255, 40);">ğŸ˜„</span>
                            <span style="color: rgb(7, 255, 35);">ğŸ˜ª</span>
                            <span style="color: rgb(7, 255, 30);">ğŸ˜£</span>
                            <span style="color: rgb(7, 255, 25);">ğŸ˜”</span>
                            <span style="color: rgb(7, 255, 20);">ğŸ˜ </span>
                            <span style="color: rgb(7, 255, 15);">ğŸ˜Œ</span>
                            <span style="color: rgb(7, 255, 10);">ğŸ˜</span>
                            <span style="color: rgb(7, 255, 5);">ğŸ˜‚</span>
                            <span style="color: rgb(7, 255, 0);">ğŸ˜¥</span>
                            <span style="color: rgb(7, 249, 0);">ğŸ˜ƒ</span>
                            <span style="color: rgb(7, 249, 5);">ğŸ˜¨</span>
                            <span style="color: rgb(7, 249, 10);">ğŸ˜’</span>
                            <span style="color: rgb(7, 249, 15);">ğŸ˜·</span>
                            <span style="color: rgb(7, 249, 20);">ğŸ˜</span>
                            <span style="color: rgb(7, 249, 25);">ğŸ‘¿</span>
                            <span style="color: rgb(7, 249, 30);">ğŸ‘½</span>
                            <span style="color: rgb(7, 249, 35);">ğŸ˜</span>
                            <span style="color: rgb(7, 249, 40);">ğŸ˜„</span>
                            <span style="color: rgb(7, 249, 45);">ğŸ˜‡</span>
                            <span style="color: rgb(7, 249, 50);">ğŸ˜¯</span>
                            <span style="color: rgb(7, 249, 55);">ğŸ˜•</span>
                            <span style="color: rgb(7, 249, 60);">ğŸ˜‚</span>
                            <span style="color: rgb(7, 249, 65);">ğŸ˜…</span>
                            <span style="color: rgb(7, 249, 70);">ğŸ˜ˆ</span>
                            <span style="color: rgb(7, 249, 75);">ğŸ˜</span>
                            <span style="color: rgb(7, 249, 80);">ğŸ˜ </span>
                            <span style="color: rgb(7, 249, 85);">ğŸ˜€</span>
                            <span style="color: rgb(7, 249, 90);">ğŸ˜ƒ</span>
                            <span style="color: rgb(7, 249, 95);">ğŸ˜†</span>
                            <span style="color: rgb(7, 249, 100);">ğŸ˜‰</span>
                            <span style="color: rgb(7, 249, 105);">ğŸ˜‘</span>
                            <span style="color: rgb(7, 249, 110);">ğŸ˜¬</span>
                            <span style="color: rgb(7, 249, 115);">ğŸ˜®</span>
                            <span style="color: rgb(7, 249, 120);">ğŸ˜¥</span>
                            <span style="color: rgb(7, 249, 125);">ğŸ˜¨</span>
                            <span style="color: rgb(7, 249, 130);">ğŸ˜Ÿ</span>
                            <span style="color: rgb(7, 249, 135);">ğŸ˜¢</span>
                            <span style="color: rgb(7, 249, 140);">ğŸ˜£</span>
                            <span style="color: rgb(7, 249, 145);">ğŸ˜¦</span>
                            <span style="color: rgb(7, 249, 150);">ğŸ˜©</span>
                            <span style="color: rgb(7, 249, 155);">ğŸ˜±</span>
                            <span style="color: rgb(7, 249, 160);">ğŸ˜µ</span>
                            <span style="color: rgb(7, 249, 165);">ğŸ˜´</span>
                            <span style="color: rgb(7, 249, 170);">ğŸ˜¤</span>
                            <span style="color: rgb(7, 249, 175);">ğŸ˜§</span>
                            <span style="color: rgb(7, 249, 180);">ğŸ˜°</span>
                            <span style="color: rgb(7, 249, 185);">ğŸ˜¶</span>
                            <span style="color: rgb(7, 249, 190);">ğŸ˜·</span>
                            <span style="color: rgb(7, 249, 195);">ğŸ˜</span>
                            <span style="color: rgb(7, 249, 200);">ğŸ˜™</span>
                            <span style="color: rgb(7, 249, 205);">ğŸ˜</span>
                            <span style="color: rgb(7, 249, 210);">ğŸ˜–</span>
                            <span style="color: rgb(7, 249, 215);">ğŸ˜</span>
                            <span style="color: rgb(7, 249, 220);">ğŸ˜›</span>
                            <span style="color: rgb(7, 249, 225);">ğŸ˜‹</span>
                            <span style="color: rgb(7, 249, 230);">ğŸ˜­</span>
                            <span style="color: rgb(7, 249, 235);">ğŸ˜”</span>
                            <span style="color: rgb(7, 249, 240);">ğŸ˜’</span>
                            <span style="color: rgb(7, 249, 245);">ğŸ˜œ</span>
                            <span style="color: rgb(7, 249, 250);">ğŸ˜—</span>
                            <span style="color: rgb(7, 249, 255);">ğŸ˜š</span>
                            <span style="color: rgb(7, 243, 255);">ğŸ˜Œ</span>
                            <span style="color: rgb(7, 243, 250);">ğŸ˜ª</span>
                            <span style="color: rgb(7, 243, 245);">ğŸ˜</span>
                            <span style="color: rgb(7, 93, 130);">ğŸ’”</span>
                            <span style="color: rgb(7, 93, 135);">ğŸ’—</span>
                            <span style="color: rgb(7, 93, 140);">ğŸ’“</span>
                            <span style="color: rgb(7, 93, 145);">ğŸ’•</span>
                            <span style="color: rgb(7, 93, 150);">ğŸ’–</span>
                            <span style="color: rgb(7, 93, 155);">ğŸ’</span>
                            <span style="color: rgb(7, 93, 160);">ğŸ’˜</span>
                        </p>
                        <span class="glyphicon glyphicon-picture upimg" aria-hidden="true" isclick='true'></span>
                        <span class="glyphicon glyphicon-paperclip" aria-hidden="true"></span> 
                        <span class="glyphicon icon-tip">â˜º</span>
                        <span class="glyphicon doudon"><img src="../user/d.jpg" alt="" style='width:20px;vertical-align:middle;'></span>
                        <span class="glyphicon glyphicon-option-horizontal" aria-hidden="true"></span>
                        <div class="spinner-">
                            <div class="rect1"></div>
                            <div class="rect2"></div>
                            <div class="rect3"></div>
                        </div>
                    </div>
                    <div class="send-btn">å‘é€</div>
                </div>
                <textarea class="form-control upimg" placeholder="......" id='show-text' ></textarea>
            </div>
        </div>
    </div>
    
    
    <!-- img -->
    <div class="imgBox">
        <div class="autoimg">
           <img src="" > 
        </div>
    </div>
    <!-- page-wrapper -->
    <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
    <!-- <script src="//cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script> -->
    <script src="//cdn.bootcss.com/socket.io/2.1.1/socket.io.js"></script>
    <script src='upload.js'></script>
    <script>
        var testREg =[
            {text:'666'}
        ]
        //  è®¾å¤‡ä¿¡æ¯è·å–
        var browser = {  
            versions: function() {  
                var u = navigator.userAgent, app = navigator.appVersion;  
                return {     //ç§»åŠ¨ç»ˆç«¯æµè§ˆå™¨ç‰ˆæœ¬ä¿¡æ¯  
                    trident: u.indexOf('Trident') > -1, //IEå†…æ ¸  
                    presto: u.indexOf('Presto') > -1, //operaå†…æ ¸  
                    webKit: u.indexOf('AppleWebKit') > -1, //è‹¹æœã€è°·æ­Œå†…æ ¸  
                    gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //ç«ç‹å†…æ ¸  
                    mobile: !!u.match(/AppleWebKit.*Mobile.*/), //æ˜¯å¦ä¸ºç§»åŠ¨ç»ˆç«¯  
                    ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //iosç»ˆç«¯  
                    android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //androidç»ˆç«¯æˆ–ucæµè§ˆå™¨  
                    iPhone: u.indexOf('iPhone') > -1, //æ˜¯å¦ä¸ºiPhoneæˆ–è€…QQHDæµè§ˆå™¨  
                    iPad: u.indexOf('iPad') > -1, //æ˜¯å¦iPad  
                    webApp: u.indexOf('Safari') == -1 //æ˜¯å¦webåº”è¯¥ç¨‹åºï¼Œæ²¡æœ‰å¤´éƒ¨ä¸åº•éƒ¨  
                };  
            } (),  
            language: (navigator.browserLanguage || navigator.language).toLowerCase()  
        }  
        //  userid ç”¨æˆ·è‡ªå·±çš„id  timeid  æœåŠ¡ç«¯æ—¶é—´  getid  æ¥æ”¶è€…id    getname  æ¥æ”¶è€…å§“å
        var receiveInfo = {
            name:'ALL',
            id:'ALL',
            img:'ALL'
        };
        var senderInfo = {
            name:'',
            id:'',
            img:''
        };
        var contactid = 'ALL';
        // èŠå¤©å®¹å™¨é«˜åº¦
        var HeightBox = $('.conetent-text-box').innerHeight();
        var socket = io.connect('ws://scopeman.cn'),userid,timeid;

        socket.on('connect',function(){
            userid = socket.id;
            setTimeout(function(){
                $('#loading').fadeOut();
            },500);
            socket.emit('start',{id:userid});
        });

        socket.on("start", function(obj) {
            timeid = obj.time;
            if(userid==obj.id){
                $('#id_ALL .textbox').append(timetmp({time:formatDate(obj.time)}));
            }
        });
        //  æ¥æ”¶ä¿¡æ¯
        socket.on("message", function(obj) {
            getMsg(obj);
        });

        socket.on('logining',function(obj){
            $('#id_ALL .textbox').append(tiptmp({tips:"--"+obj.name+'--åŠ å…¥èŠå¤©å®¤'}));
            if(obj.id==userid){
                $('#title-name').text(obj.name);
                $('#title-img').attr('src',obj.img);
            }else{
                $('#mCSB_1_container').append(peopletmp(obj));
                $('#id_ALL .textbox').append(tiptmp());
            }
        });

        socket.on("loginout", function(obj) {
            if(obj.status==1){

                $('#'+obj.id).addClass('out');

            }else if(obj.status==0){

                $('#'+obj.id).parent().remove();

                $('#id_ALL .textbox').append(tiptmp({tips:"--"+obj.name+'--ç¦»å¼€èŠå¤©å®¤'}));

            }else if(obj.status==2){

                $('#'+obj.id).removeClass('out');
            }
            
        });
        
        //æ¥æ”¶æ¶ˆæ¯æ–¹æ³•
        function getMsg(obj){
            
            if(obj.time-timeid>60000){
                $('#id_ALL .textbox').append(timetmp({time:formatDate(obj.time)}));
            }
            timeid = obj.sender.time;
            //  åˆ¤æ–­æ˜¯ç¾¤èŠè¿˜æ˜¯ç§èŠ
            if(obj.contactid != "ALL"){
                //  ç§èŠ
                privateChat(obj)
            }else{
                //  ç¾¤èŠ
                groupChat(obj)
            }
        }
        //  ç¾¤èŠæ–¹æ³•
        function groupChat(obj){
            if(obj.sender.id == userid){
                // å‘é€è€…
                if(obj.shake){
                    obj.text = 'ç¾¤æŠ–åŠ¨æš‚æ—¶å¼€æ”¾--ä¿æŠ¤èŠå¤©ç¯å¢ƒè¯·å°‘ç”¨ã€‚';
                    shakeFun(obj);
                }else{
                   $('#id_ALL .textbox').append(sendmsgtmp(obj));
                }
                //  æ»šåŠ¨
                boxScrollTop(obj)
                
            }else{
                // æ¥æ”¶è€…
                $('#id_ALL .textbox').append(getmsgtmp(obj));
                // æ»šåŠ¨
                boxScrollTop(obj)
                //  æ”¶ä¿¡æ¯æé†’
                messageTips(obj);
            }
            $('#show-text').val('');
        }
        // ç§èŠæ–¹æ³•
        function privateChat(obj){
            if(obj.sender.id == userid){
                // å‘é€è€…
                if(obj.shake){
                    obj.text = 'ä½ ç»™å¯¹æ–¹å‘åŠ¨äº†ä¸€ä¸ªæŠ–åŠ¨';
                    shakeFun(obj);
                }else{
                   $('#id_'+obj.contactid+' .textbox').append(sendmsgtmp(obj));
                   $('#show-text').val('');
                }
                boxScrollTop(obj)
            }
            if(obj.receive.id == userid){
                // æ¥æ”¶è€…
                if($("#"+obj.sender.id).length==0){
                    $('#mCSB_1_container').append(peopletmp1(obj)); 
                }else{
                    $("#"+obj.sender.id).attr('ids',obj.contactid);
                }
                if($('#id_'+obj.contactid).length==0){
                    $('.content-info').append(createchatroom(obj.contactid,"display:none"));
                }
                // æŠ–åŠ¨æ¶ˆæ¯
                if(obj.shake){
                    obj.text = 'å¯¹æ–¹ç»™ä½ å‘åŠ¨äº†ä¸€ä¸ªæŠ–åŠ¨';
                    shakeFun(obj)
                }else{
                    $('#id_'+obj.contactid+' .textbox').append(getmsgtmp(obj));
                }
                //  æ»šåŠ¨
                boxScrollTop(obj)
                //  æ”¶ä¿¡æ¯æç¤º
                messageTips(obj)
            }
        }
        //  è®¡ç®—å®¹å™¨æ»šåŠ¨
        function boxScrollTop(obj){
            var h = $('#id_'+obj.contactid).find('.textbox').height();
            setTimeout(function(){
                var h = $('#id_'+obj.contactid).find('.textbox').height();
                if(h>HeightBox){
                    $('#id_'+obj.contactid).animate({scrollTop:h-HeightBox+50},500)
                }
            },0)
        }
        // æ¶ˆæ¯æŠ–åŠ¨æ–¹æ³•
        function shakeFun(obj){
            $('#id_'+obj.contactid+' .textbox').append(shaketmp(obj));
            $('.chat-interface').addClass('shake-animate');
            timer = setTimeout(function(){
                $('.chat-interface').removeClass('shake-animate');
            },2000)
        }
        //  æ¶ˆæ¯æé†’
        function messageTips(obj){
            var id = $('.content-bar li.active').find('span').attr('id'),ids;
            if(obj.receive.id=='ALL'){
                ids = 'ALLUser';
            }else{
                ids = obj.sender.id
            }
            if(id!=ids){
                var dom = $('#'+ids).parent();
                if(dom.find('i').length==0){
                    dom.append("<i class='breath'>1</i>");
                }else{
                    var num = parseInt(dom.find('i').text())+1;
                    dom.find('i').text(num) 
                }

                // æ‰‹æœºç«¯æ¥æ”¶ä¿¡æ¯æç¤º
                if (browser.versions.mobile) {
                    $('.info-3').addClass('tipMsg');
                }
                
            }
        }
        // äººç‰©æ¨¡æ¿
        function peopletmp(obj){
            var text = "<li>\
                            <div class='line'></div>\
                            <img src='"+obj.img+"' alt=''>\
                            <b>"+obj.name+"</b>\
                            <span id="+obj.id+"></span>\
                        </li>";
            return text;
        }
        function peopletmp1(obj){
            var text = "<li>\
                            <div class='line'></div>\
                            <img src='"+obj.sender.img+"' alt=''>\
                            <b>"+obj.sender.name+"</b>\
                            <span ids="+obj.contactid+" id='"+obj.sender.id+"'></span>\
                        </li>";
            return text;
        }
        // å‘é€æ¶ˆæ¯æ¨¡æ¿
        function sendmsgtmp(obj){
            var imgstr = '',w = 150;
            if(obj.uploadimg){
                if(obj.fileobj.type == 'img'){
                    if(obj.fileobj.width<100){ w = obj.fileobj.width;}
                    imgstr = "<div class='img-content-show' style='padding-top:"+100/obj.fileobj.scale+"%;width:"+w+"px'><img src='../"+obj.uploadimg+"' class='text-img' data-show='show' onload='loadimg(this)'></div>";
                }else{
                    imgstr = "<div class='img-content-show' style='width:100px;height:100px;'><a href='../"+obj.uploadimg+"' download='"+obj.fileobj.name+"'><img src='../user/"+obj.fileobj.type+".png' class='text-img'  onload='loadimg(this)'></a></div>";
                }
            }
            var text = "<div class='chat-item'>\
                            <div class='msgname msgname-send'>"+obj.sender.name+"</div>\
                            <div class='chat-list chat-our'>\
                                <div class='chat-text'>"+imgstr+obj.text+"</div>\
                                <img src='"+obj.sender.img+"' alt='"+obj.sender.name+"' >\
                            </div>\
                        </div>";
            return text;
        }
        // æ¥æ”¶æ¶ˆæ¯æ¨¡æ¿
        function getmsgtmp(obj){
            var imgstr = '',w = 150;
            if(obj.uploadimg){
                if(obj.fileobj.type == 'img'){
                    if(obj.fileobj.width<100){ w = obj.fileobj.width;}
                    imgstr = "<div class='img-content-show' style='padding-top:"+100/obj.fileobj.scale+"%;width:"+w+"px'><img src='../"+obj.uploadimg+"' class='text-img' data-show='show' onload='loadimg(this)'></div>";
                }else{
                    imgstr = "<div class='img-content-show' style='width:150px;height:150px;'><a href='../"+obj.uploadimg+"' download='"+obj.fileobj.name+"'><img src='../user/"+obj.fileobj.type+".png' class='text-img' onload='loadimg(this)'></a></div>";
                }
            }
            var text = "<div class='chat-item'>\
                            <div class='msgname msgname-get'>"+obj.sender.name+"</div>\
                            <div class='chat-list chat-other'>\
                                <img src='"+obj.sender.img+"' alt='"+obj.sender.name+"'>\
                                <div class='chat-text'>"+imgstr+obj.text+"</div>\
                            </div>\
                        </div>";
            return text;
        } 
        // æŠ–åŠ¨æ¶ˆæ¯æ¨¡æ¿
        function shaketmp(obj){
            var text = "<div class='chat-item' style='text-align:center;'>\
                    <div class='shake'>"+obj.text+"</div>\
                </div>";
            return text;
        }
        // æ—¶é—´æ¨¡æ¿
        function timetmp(obj){
            var text = "<div class='chat-item'><div class='time-item'>"+obj.time+"</div></div>";
            return text;
        }
        // æç¤ºæ¨¡æ¿
        function tiptmp(obj){
            var obj = obj?obj:{tips:'è¯¥æˆå‘˜ä½ ä¸è®¤è¯† æ¶‰åŠåˆ°é‡‘é’±çš„ä½ ä»¬è¿˜è¯·æ³¨æ„!'};
            var text = "<div class='chat-item chat-tip-on'><div class='chat-tips'><span class='glyphicon glyphicon-exclamation-sign' aria-hidden='true'></span><span>"+obj.tips+"</span></div></div>";
            return text;
        }
        // ç©ºç™½ æ¨¡æ¿
        function blanktmp(){
            var text = "<div class='blank-show'> </div>";
            return text;
        }
        // åˆ›å»ºèŠå¤©æ–°å®¹å™¨
        function createchatroom(id,style){
            var text = "<div class='conetent-text-box scrollbar' id='id_"+id+"' style='"+style+"'>\
                            <div class='textbox'></div>\
                        </div>";
            return text;
        }
        // unit å·¥å…·æ—¶é—´æˆ³æ ¼å¼åŒ–
        function formatDate(t){
            var date = new Date(t);  
            var y = date.getFullYear();    
            var m = date.getMonth() + 1;    
            m = m < 10 ? ('0' + m) : m;    
            var d = date.getDate();    
            d = d < 10 ? ('0' + d) : d;    
            var h = date.getHours();  
            h = h < 10 ? ('0' + h) : h;  
            var minute = date.getMinutes();  
            var second = date.getSeconds();  
            minute = minute < 10 ? ('0' + minute) : minute;  
            second = second < 10 ? ('0' + second) : second; 
            return y + '-' + m + '-' + d+' '+h+':'+minute+':'+second;   
        }
        //  äº‹ä»¶ 
        $('.user-img div').on('click',function(){
            $(this).siblings().find('span').removeClass('glyphicon glyphicon-ok');
            $(this).find('span').addClass('glyphicon glyphicon-ok');
        })
        $('.btn-go').on('click',function(){
            var img = $('.user-img div').find('.glyphicon-ok').prev().attr('src');
            var username = $('#usernameval').val();
            if(!username){
                $('.username').css({color:'#D8231D'});
                $('#usernameval').css({borderColor:'#D8231D'});
                return;
            }

            //  è®¾ç½®é“¾æ¥ç”¨æˆ·ä¿¡æ¯
            senderInfo.id = socket.id;
            senderInfo.name = username;
            senderInfo.img = img;

            socket.emit('login',senderInfo);
            $('.modal-show').fadeOut(800);
        })
        // è·å–æ¥æ”¶è€…çš„id
        $('.content-bar').on('click','li',function(){

            $(this).addClass('active').siblings().removeClass('active');
            $(this).find('.breath').remove();

            var name = $(this).find('b').text(),
                id = $(this).find('span').attr('id'),
                ids =$(this).find('span').attr('ids')?$(this).find('span').attr('ids'):id,
                img = $(this).find('img').attr('src');

            //  è®¾ç½®æ¥æ”¶è€…ä¿¡æ¯
            if(id != 'ALLUser'){
                //  æŒ‡å®šèŠå¤©å¯¹è±¡
                receiveInfo.name = name;
                receiveInfo.id = id;
                receiveInfo.img = img;
                
                if($('#id_'+ids).length!=0){
                    //  å·²ç»å­˜åœ¨
                    $('#id_'+ids).show().siblings().hide();
                }else{
                    //  åŠ¨æ€ç”Ÿæˆ
                    //  æ²¡æœ‰èŠå¤©çª—å£åˆ›å»ºèŠå¤©çª—å£
                    $('.content-info').append(createchatroom(ids));
                    $('#id_'+ids).siblings().hide();
                }
                // æ·»åŠ  ids å±æ€§
                if(!$(this).find('span').attr('ids')){
                    $(this).find('span').attr('ids',ids);
                }
                contactid = ids;
            }else{
                //  ç¾¤èŠ
                receiveInfo.name = 'ALL';
                receiveInfo.id = 'ALL';
                receiveInfo.img = 'ALL';
                contactid = 'ALL';
                $('#id_ALL').show().siblings().hide();

            }
            
        })
        
         // å‘é€æ¶ˆæ¯
         $('.send-btn').on('click',function(){
            var text = $('#show-text').val();
            if(text.length!=0){
                socket.emit('message',{
                    text:text,
                    sender:senderInfo,
                    receive:receiveInfo,
                    contactid:contactid
                });
            }
        })
        // xiu
        $('.doudon').on('click',function(){
            if($('.chat-interface').hasClass('shake-animate')){
                return;
            }
            socket.emit('message',{
                text:'å¯¹æ–¹ç»™ä½ å‘é€äº†ä¸€ä¸ªæŠ–åŠ¨',
                sender:senderInfo,
                receive:receiveInfo,
                contactid:contactid,
                shake:true
            });
        })
        //  emji å›¾åƒ
        $('.icon-tip').on('click',function(e){
            e.stopPropagation();
            $('.icon-style').toggle();
        })
        $('.icon-style').on('click',function(e){
            e.stopPropagation();
            var val = $('#show-text').val(),text='';
            if(e.target.nodeName=='SPAN'){
                text = $(e.target).text();
            }
            $('#show-text').val(val+text);
        })
        $(document).on('click',function(e){
            $('.icon-style').hide();
        })
        // å›è½¦è§¦å‘å‘é€æ¶ˆæ¯
        $(document).keyup(function(event){
            if(event.keyCode ==13){
                $('.send-btn').trigger('click');
            }
        });
        ///////æµè§ˆå™¨ å…³é—­äº‹ä»¶ ç”¨æˆ·ç¦»å¼€  status æ˜¯ç”¨æˆ·çŠ¶æ€ 0  è¡¨ç¤ºé€€å‡º  1   è¡¨ç¤ºç¦»å¼€çŠ¶æ€  2  è¡¨ç¤ºåœ¨çº¿çŠ¶æ€
        window.onbeforeunload = function(){
            socket.emit('loginout',{id:userid,status:0})
        }
        document.addEventListener('visibilitychange',function(){
            if(document.visibilityState=='hidden') {   
                socket.emit('loginout',{id:userid,status:1})
            }else{
                socket.emit('loginout',{id:userid,status:2})
            }
        });
        $('.content-info').on('click','.text-img',function(){
            var src = $(this).attr('src'),show = $(this).attr('data-show');
            if(show=='show'){
                $('.imgBox').fadeIn(800);
                $('.autoimg img').attr('src',src);
            }
            
        })
        $('.imgBox').on('click',function(e){
            if(e.target.nodeName == 'IMG')return;
            $('.imgBox').fadeOut(500);
        })
        //  å›¾ç‰‡ä¸Šä¼ 
        upload('.upimg',
            function(){
                $('.spinner-').show();
            },
            function(data,id){
                
            },
            function(data,obj){

                socket.emit('message',{
                        text:'',
                        sender:senderInfo,
                        receive:receiveInfo,
                        contactid:contactid,
                        uploadimg:data.url,
                        fileobj:obj
                });

                $('.spinner-').hide();
            },
            function(data,id){
                
                
            },'chatroom/chatimg'
        );
        //  å›¾ç‰‡é¢„åŠ è½½
        function loadimg(img){
            $(img).css({opacity:1}).parent().css({background:'none'});
        }
        // åˆ¤æ–­æ˜¯è®¾å¤‡
        if (browser.versions.mobile) {
            $('.info-3').on('click',function(){
                $('.contact-bar').toggleClass('trans')
            });
            $('.content-bar').on('click','li',function(){
                $('.contact-bar').removeClass('trans');
                if($('.breath').length==0){
                    $('.info-3').removeClass('tipMsg');
                }
            })
        }  
  
    </script>
</body>

</html>